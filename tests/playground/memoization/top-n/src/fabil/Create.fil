import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.util.Random;

import fabric.util.Map;

public class Create {
  public static String USAGE =
"USAGE: Create NUM_USERS P\n" +
"\n" +
"       Runs a worker to create the user database for the top n test with\n" +
"       NUM_USERS users and using P for the power law parameter for the\n" +
"       distribution of number of followers.";

  /**
   * Create configuration.
   */
  public static void configure(int numUsers, double power) {
    atomic {
      Map m = Config.STORE.getRoot();
      Store s = Config.STORE;
      m.put("config", new Config@s(numUsers, power).Config$());
    }
  }

  /**
   * Populate the store with n users and pre-compute the memoized call for the
   * top c users.
   */
  public static void populateUsers() {
    Store s = Config.STORE;
    Map m = Config.STORE.getRoot();
    Config c = null;
    
    // Check if we've already initialized the database.
    atomic {
      if (m.containsKey("tester")) return;
      c = (Config) m.get("config");
    }

    // Create users.
    atomic {
      for (int i = 0; i < c.NUM_USERS; i++) {
        m.put(new Integer(i),
            new TwooterAccount@s("UID" + i).TwooterAccount$());
      }
    }

    // Initialize followers.
    atomic {
      Random rand = new Random(0xBEEFFEED);
      for (int i = 0; i < c.NUM_USERS; i++) {
        TwooterAccount acct = (TwooterAccount) m.get(new Integer(i));
        int numFollowers = randomNumberUsers(c.POWER, c.NUM_USERS, rand);
        for (int j = 0; j < numFollowers; j++) {
          acct.addRandomFollower(rand);
        }
      }
    }

    // Create test object.
    Tester t = null;
    atomic {
      t = new Tester@s().Tester$();
      m.put("tester", t);
    }
    System.out.println("done " + t);
  }

  /**
   * Using a power law distribution with the given parameter, pick a number of
   * users.
   */
  public static int randomNumberUsers(double power, int userCount, Random rand) {
    return (int) Math.round(Math.pow(Math.pow(userCount, 1.0 + power) *
          rand.nextDouble(), 1.0 / (power - 1.0)));
  }

  public static void main(String[] args) {
    if (args.length != 2) {
      System.err.println(USAGE);
      System.exit(1);
    }
    configure(Integer.parseInt(args[0]), Double.parseDouble(args[1]));
    populateUsers();
  }
}
