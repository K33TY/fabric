package customer;

import javax.servlet.ServletException;
import travel.*;
import fabric.util.Map;
import travel.Broker;

import sif.html.*;
import sif.servlet.Action;
import sif.servlet.Request;
import sif.servlet.Servlet;


public class StartTransaction extends CustomerAction {

    final Input[CustomerPrincipal]{CustomerPrincipal←} inp;
    
    public StartTransaction(CustomerMain{this} m, Input[CustomerPrincipal]{CustomerPrincipal←} inp) throws ServletException {
        this.inp = inp;
        super();
        initFields("starttx", m);
    }
    
    public final void invoke{*lbl}(label{*lbl} lbl, Request[CustomerPrincipal]{*lbl} req) 
    throws (ServletException{*lbl;⊤→req.session;req.session←})
    where caller(req.session),
    lbl <= {⊤→req.session} {

        Servlet[CustomerPrincipal] servlet = getServlet();
        if (servlet == null || !(servlet instanceof CustomerMain)) throw new ServletException("No servlet available"); 
        if (req == null) throw new ServletException("No request available"); 
        CustomerMain m = (CustomerMain)servlet;
        
        final Core bcore = client$.getCore(Config.brokerCoreName);
        Map root = null;
        if (bcore != null) {
            root = (Map) bcore.getRoot();
        }
        if (root == null) return;
        Broker[BankPrincipal, CustomerPrincipal] brokerInit = null;
        Object obj = root.get(Config.brokerMapKey);
        if (obj instanceof Broker[BankPrincipal, CustomerPrincipal]) {
            brokerInit =
                (Broker[BankPrincipal, CustomerPrincipal])obj;
        }
        final Broker[BankPrincipal, CustomerPrincipal] broker = brokerInit;
        
        String amountStr = req.getParam(inp);
        final label labl = new label {⊤←};
        Main main = new Main{*labl}@bcore();
        boolean failure = false;
        float amount = 0;
        try {
            if (lbl <= new label {CustomerPrincipal←} &&
                    inp.inputLbl <= new label {BankPrincipal→AirlinePrincipal,CustomerPrincipal; CustomerPrincipal←} &&
                    req.session actsfor CustomerPrincipal &&
                    bcore actsfor BankPrincipal &&
                    bcore actsfor broker) {
                
                try {
                    amount = Float.parseFloat(amountStr);
                } catch (NumberFormatException e) {
                    amount = 0;
                }
                failure = !main.startTx@bcore(amount, broker);
            }
        } catch (NullPointerException unlikely) {
            failure = true;
        }
        
        final label ll = new label 
        {BankPrincipal→CustomerPrincipal;broker←;BankPrincipal←;AirlinePrincipal←;CustomerPrincipal←; *lbl}; 
        String message1 = failure?"Sorry, your purchase could not be performed":"Your purchase was successful";
        String message2 = failure?"Unsuccessful Purchase":"Successful Purchase";

        // print a page saying that purchase was successful
        if (lbl <= new label {CustomerPrincipal←} && req.session actsfor CustomerPrincipal) {
            Text msg = new Text[ll, lbl](message1);
            SubmitButton submit = new SubmitButton[CustomerPrincipal, ll, lbl](m, ll, "Back");
            NodeList[ll, lbl] entries = NodeList.EMPTY();
            entries = entries==null?null:entries.append(new TRow[ll, lbl](
                    new NodeList[ll, lbl](msg)));
            entries = entries==null?null:entries.append(new TRow[ll, lbl](
                    new NodeList[ll, lbl](submit)));
            Node[ll, lbl] form = servlet.createForm(ll, lbl, 
                    m.findStartAction("frontpage"),
                    ll, lbl,
                    new Table[ll, lbl](entries));
            servlet.createPage(req, message2, ll, lbl,
                    new NodeList[ll,lbl](ll, lbl, createBody(ll, lbl, form)));
        }
    }
}