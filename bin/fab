#!/bin/bash

# Wrapper script for fabric.worker.Worker, the Fabric worker.

source "$(dirname $0)/defs"
CODECACHE=".${HOSTNAME}_cache"

DEBUG_OPTS="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,address=3371"

while true; do
  case "$1" in
    "") break;;
    -v)           verbose="1";             shift 1;;
    -cp)          EXTRACP=$2;              shift 2;;
    -classpath)   EXTRACP=$2;              shift 2;;
    -j)           vmargs="${vmargs} '$2'"; shift 2;;
    --code-cache)
        CODECACHE=$2
        args="${args} --code-cache '$2'"
        shift 2
        ;;
    --name)
        CODECACHE=".${2}_cache"
        args="${args} --name '$2'"
        shift 2
        ;;
    --debug)
        vmargs="${vmargs} ${DEBUG_OPTS},suspend=n"
        shift 1
        ;;
    --suspend)
	vmargs="${vmargs} ${DEBUG_OPTS},suspend=y"
	shift 1
	;;
            
    *) args="${args} '$1'"; shift;;
  esac
done

mkdir -p ${CODECACHE}
classpath="${FABRIC_WORKER_CP}:${EXTRACP}:${classpath}:${CODECACHE}"

#command="\"${JAVA}\" ${vmargs} -classpath \"$(fixpath ${classpath})\" fabric.worker.Worker ${args}"
sigcp="${TOP}/sig-classes/fabric:${TOP}/lib/fabric-sig.jar:${sigcp}"
filsigcp="${TOP}/sig-classes/fabil:${TOP}/lib/fabric-il-sig.jar:${filsigcp}"
command="\"${JAVA}\" ${vmargs} -classpath \"$(fixpath ${classpath})\" \
					fabric.worker.Worker --bootclasspath \"$(fixpath ${FABRIC_BOOTCP})\" \
                               --sigcp \"$(fixpath ${sigcp})\" \
                               --filsigcp \"$(fixpath ${filsigcp})\" ${args}"

if [ -n "${localcode}" ]
then
  command="${commandlocal}"
fi

if [ -n "${verbose}" ]
then
  echo "${command}"
fi

eval "${command}"
