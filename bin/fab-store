#!/bin/bash

# Wrapper script for fabric.store.Main, the Fabric store.

source "$(dirname $0)/defs"

debug_opts="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,address=3370"

# default app home is Fabric root
app_home="$(dirname $0)/.."

# default cache name is hostname
cache_name="${HOSTNAME}_cache"

while true; do
  case "$1" in
    "") break;;
    -v) verbose="1"; shift;;
    --jvm-cp) jvmcp=$2; shift; shift;;    
    --code-cache)
      code_cache=$2
      args="${args} --code-cache '$2'"
      shift 2
      ;;
    --name)
      cache_name="$2_cache"
      args="${args} --name '$2'"
      shift 2
      ;;
    --app-home)
      app_home=$2
      shift 2
      ;;
    -j)
      shift
      vmargs="${vmargs} '$1'"
      shift
      ;;
    --debug)
      vmargs="${vmargs} ${debug_opts},suspend=n"
      shift
      ;;
    --suspend)
      vmargs="${vmargs} ${debug_opts},suspend=y"
      shift 1
      ;;
    *) args="${args} '$1'"; shift;;
  esac
done

# Export location of config, etc, and var 
export FABRIC_HOME="${app_home}"
if [ -z "${code_cache}" ]; then
  code_cache=${FABRIC_HOME}/var/${cache_name}
fi
mkdir -p ${code_cache}

classpath="${FABRIC_STORE_CP}:${jvmcp}:${classpath}:${code_cache}"

sigcp="${TOP}/sig-classes/fabric:${TOP}/lib/fabric-sig.jar"
filsigcp="${TOP}/sig-classes/fabil:${TOP}/lib/fabric-il-sig.jar"
command="\"${JAVA}\" $vmargs -classpath \"$(fixpath $classpath)\" \
             fabric.store.Node --bootclasspath \"$(fixpath ${FABRIC_BOOTCP})\" \
                               --sigcp \"$(fixpath ${sigcp})\" \
                               --filsigcp \"$(fixpath ${filsigcp})\" ${args}"

if [ -n "${verbose}" ]; then
  echo "${command}"
fi

eval "${command}"

# vim: ts=2 sw=2 ai et
