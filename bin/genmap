#!/bin/bash

source "$(dirname $0)/defs"

CORE="${TOP}/bin/fab-core"
FAB="${TOP}/bin/fab"
KEYDIR="${TOP}/etc/keys"

# create core command
classpath="$classpath:${TOP}/classes:${TOP}/lib/fabric.jar:${TOP}/lib/je-3.2.68.jar"
command="\"$JAVA\" -classpath \"$(fixpath $classpath)\" fabric.core.Main"

for i in "$@"; do
  command="$command --core $i ${KEYDIR}/$i.keystore ${KEYDIR}/trust.keystore password"
done

# run command, and block until the first line of output is written
head -n 1 <(eval $command)
corepid=$!

# run genmap against each core.
for i in "$@"; do
  "${FAB}" fabric.core.GenMap "$i"
done

# kill the core
kill $(ps --ppid $corepid h -o pid)

