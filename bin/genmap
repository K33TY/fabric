#!/bin/bash

source "$(dirname $0)/defs"

CORE="${TOP}/bin/fab-core"
FAB="${TOP}/bin/fab"
KEYDIR="${TOP}/etc/keys"

#
# kill the children of a given PID
killchildren () {
  pid=$1

  if [ `uname | grep -c CYGWIN` -ne 0 ]; then
    # windows - find use awk to find the process list
    # cygwin ps -l:
    # PID PPID PGID WINPID TTY UID STIME COMMAND
    pslist=$(ps -l | awk "\$2 == $pid {print \$1}")
  else
    pslist=$(ps --ppid $pid h -o pid)
  fi

  kill $pslist
}

# create core command
classpath="$classpath:${TOP}/classes:${TOP}/lib/fabric.jar:${TOP}/lib/je-3.2.68.jar"
command="\"$JAVA\" -classpath \"$(fixpath $classpath)\" fabric.core.Main"

for i in "$@"; do
  command="$command --core $i \"$(fixfilename "${KEYDIR}/$i.keystore")\" \"$(fixfilename "${KEYDIR}/trust.keystore")\" password"
done

# run command, and block until the first line of output is written
head -n 1 <(eval $command)
corepid=$!

# run genmap against each core.
for i in "$@"; do
  "${FAB}" fabric.core.GenMap "$i"
done

# kill the core
killchildren $corepid
