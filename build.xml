<project name="fabric" default="all" basedir=".">
  <description>
    Fabric build file
  </description>

  <!-- Set global properties for this build -->

  <!-- Source directory -->
  <property name="src" location="${basedir}/src"/>
  <property name="system.src" location="${src}/system"/>
  <property name="compiler.src" location="${src}/compiler"/>
  <property name="runtime.src" location="${src}/runtime"/>
  <property name="signatures.src" location="${src}/signatures"/>

  <!-- Directory for class file targets -->
  <property name="classes" location="${basedir}/classes"/>
  <property name="runtime.classes" location="${basedir}/rt-classes"/>
  <property name="signatures.classes" location="${basedir}/sig-classes"/>

  <!-- Distribution directory -->
  <property name="dist" location="${basedir}/dist"/>

  <!-- Binaries directory -->
  <property name="bin" location="${basedir}/bin"/>

  <!-- Library directory -->
  <property name="lib" location="${basedir}/lib"/>

  <!-- loom executable -->
  <property name="loom" location="${bin}/loom" />

  <path id="standard.classpath">
    <pathelement location="${classes}"/>
    <pathelement path="${java.class.path}" />
    <pathelement location="${lib}"/>

    <!-- jar files in the lib directory, excluding generated jars -->
    <fileset dir="${lib}">
        <include name="*.jar" />
        <exclude name="${name}.jar" />
        <exclude name="${name}-rt.jar" />
    </fileset>
  </path>

  <target name="configure" description="Configures Fabric"
      unless="configure.up-to-date">
    <echo message="java version is ${java.version}"/>
    <echo message="current directory is ${user.dir}"/>
    <echo message="Java home directory is ${java.home}"/>
    <property name="configure.up-to-date" value="true"/>
  </target>

  <!-- Create appropriate executables in the bin directory -->
  <target name="bin" depends="configure,bin-deps" unless="bin.up-to-date">
    <antcall target="fabric-bin"/>
  </target>

  <target name="bin-deps">
    <dependset>
      <srcfileset dir="${bin}" includes="fabric.in"/>
      <targetfileset dir="${bin}" includes="fabric"/>
    </dependset>
    <condition property="bin.up-to-date">
      <and>
        <available file="${bin}/fabric"/>
        <available file="${bin}/tailor"/>
	<available file="${bin}/loom"/>
      </and>
    </condition>
  </target>

  <target name="defs-deps">
    <condition property="defs.up-to-date">
      <available file="${bin}/defs"/>
    </condition>
  </target> 

  <!-- Creates a file containing common environment variable definitions -->
  <target name="executable-defs" depends="defs-deps" unless="defs.up-to-date">
    <echo message="Creating ${bin}/defs"/>
    <echo file="${bin}/defs" append="no">#!/bin/sh
# DO NOT EDIT - This file was automatically generated.

JAVA='${java.home}/bin/java'
FILE_SEP='${file.separator}'
PATH_SEP='${path.separator}'
TOP='${basedir}'
    </echo>
  </target>

  <target name="fabric-bin" depends="executable-defs">
    <echo message="Creating ${bin}/fabric"/>
    <concat destfile="${bin}/fabric" append="no">
      <filelist dir="${bin}" files="defs"/>
      <filelist dir="${bin}" files="fabric.in"/>
    </concat>

    <chmod perm="+x" file="${bin}/fabric"/>

    <echo message="Creating ${bin}/loom"/>
    <concat destfile="${bin}/loom" append="no">
      <filelist dir="${bin}" files="defs"/>
      <filelist dir="${bin}" files="loom.in"/>
    </concat>

    <chmod perm="+x" file="${bin}/loom"/>

    <echo message="Creating ${bin}/tailor"/>
    <concat destfile="${bin}/tailor" append="no">
      <filelist dir="${bin}" files="defs"/>
      <filelist dir="${bin}" files="tailor.in"/>
    </concat>

    <chmod perm="+x" file="${bin}/tailor"/>

    <delete file="${bin}/defs"/>
  </target>

  <!-- Initialise the build -->
  <target name="init" depends="configure">
    <!-- Create the time stamp -->
    <tstamp/>
    <!-- Create the build directory structure used by compile -->
    <mkdir dir="${classes}"/>
    <mkdir dir="${runtime.classes}"/>
    <mkdir dir="${signatures.classes}"/>
  </target>

  <!-- Compiles Fabric -->
  <target name="all"
    depends="bin,fabric-system,fabric-compiler,fabric-signatures,tests"
    description="Builds Fabric"/>

  <!-- Compiles the Fabric system -->
  <target name="fabric-system" depends="core,client" description="Builds Fabric"/>

  <target name="clean" description="Cleans up the directory tree: deletes the distribution directory and the classes directories">
    <!-- Delete the ${classes} and ${dist} directory trees -->
    <delete dir="${classes}"/>
    <delete dir="${runtime.classes}"/>
    <delete dir="${signatures.classes}"/>
    <delete dir="${dist}"/>
  </target>

  <target name="clobber" depends="clean"
      description="Cleans up the directory tree and deletes generated files">
    <delete>
      <fileset dir="${bin}">
        <include name="fabric"/>
        <include name="defs"/>
      </fileset>
    </delete>
  </target>

  <!-- Compiles the Fabric core -->
  <target name="core" depends="init,fabric-runtime">
    <javac srcdir="${system.src}" destdir="${lib}" debug="on">
      <include name="fabric/core/**" />
      <include name="fabric/common/**" />
      <include name="fabric/messages/**" />
      <classpath>
	<path refid="standard.classpath"/>
	<pathelement location="${runtime.classes}" />
      </classpath>
    </javac>
  </target>

  <!-- Compiles the Fabric client API -->
  <target name="client" depends="init">
    <javac srcdir="${system.src}" destdir="${classes}" debug="on">
      <include name="fabric/client/**" />
      <include name="fabric/common/**" />
      <include name="fabric/messages/**" />
      <include name="fabric/lang/**" />
      <classpath refid="standard.classpath"/>
    </javac>
  </target>

  <!-- Compiles the Fabric compiler -->
  <target name="fabric-compiler" depends="init,configure,client">
    <antcall target="standard-ext">
      <param name="ext" value="fabric" />
      <param name="ext.pkg" value="fabric" />
      <param name="parser.type" value="ppg" />
    </antcall>
  </target>

  <!-- Compiles the Fabric signatures -->
  <target name="fabric-signatures" depends="init,fabric-compiler">
    <mkdir dir="${signatures.classes}" />
    <apply executable="${loom}"
	parallel="false"
	failonerror="true"
	dest="${basedir}"
	relative="true"
	skipemptyfilesets="true"
	vmlauncher="false">
      <arg value="-sig" />
      <arg value="-d" />
      <arg value="sig-classes" />
      <arg value="-sourcepath" />
      <arg value="src/signatures:src/runtime" />
      <srcfile />
      <fileset dir="${basedir}"
	  includes="src/signatures/fabric/lang/Object.fab" />
      <mapper type="regexp" from="src/signatures(.*)\.fab"
	  to="sig-classes\1\.class" />
    </apply>

    <apply executable="${loom}"
	parallel="true"
	failonerror="true"
	dest="${basedir}"
	relative="true"
	skipemptyfilesets="true"
	vmlauncher="false">
      <arg value="-sig" />
      <arg value="-d" />
      <arg value="sig-classes" />
      <arg value="-sourcepath" />
      <arg value="src/signatures" />
      <arg value="-sigcp" />
      <arg value="sig-classes" />
      <srcfile />
      <fileset dir="${basedir}" includes="src/signatures/**/*.fab" />
      <mapper type="regexp" from="src/signatures(.*)\.fab"
	  to="sig-classes\1\.class" />
    </apply>
  </target>

  <!-- Compiles the Fabric runtime -->
  <target name="fabric-runtime"
      depends="init,fabric-compiler,fabric-signatures">
    <mkdir dir="${runtime.classes}" />
    <apply executable="${loom}"
	parallel="true"
	failonerror="true"
	dest="${basedir}"
	relative="true"
	skipemptyfilesets="true"
	vmlauncher="false">
      <arg value="-d" />
      <arg value="rt-classes" />
      <arg value="-sigcp" />
      <arg value="sig-classes" />
      <arg value="-sourcepath" />
      <arg value="src/runtime" />
      <srcfile />
      <fileset dir="${basedir}"
	  includes="src/runtime/**/*.fab"
	  excludes="src/runtime/fabric/util/*.fab" />
      <mapper type="regexp" from="src/runtime(.*)\.fab"
	  to="classes\1\.class" />
    </apply>

    <apply executable="${loom}"
	parallel="true"
	failonerror="true"
	dest="${basedir}"
	relative="true"
	skipemptyfilesets="true"
	vmlauncher="false">
      <arg value="-d" />
      <arg value="rt-classes" />
      <arg value="-sigcp" />
      <arg value="sig-classes" />
      <arg value="-sourcepath" />
      <arg value="src/runtime" />
      <srcfile />
      <fileset dir="${basedir}"
	  includes="src/runtime/fabric/util/HashMap.fab" />
      <mapper type="regexp" from="src/runtime(.*)\.fab"
	  to="classes\1\.class" />
    </apply>
  </target>

  <!-- Compiles the Fabric test programs -->
  <target name="tests" depends="init,fabric-system">
    <javac srcdir="${src}" destdir="${classes}" debug="on" includes="tests/**">
      <classpath refid="standard.classpath"/>
    </javac>
  </target>

  <!--
    Here begins generic helper stuff for building Polyglot extensions.
  -->

  <target name="standard-ext">
    <antcall target="standard-ext-lexer" />
    <antcall target="standard-ext-${parser.type}-parser" />
    <antcall target="standard-ext-qq-dep" />
    <antcall target="compile-ext" />
  </target>

  <target name="standard-ext-lexer">
    <antcall target="jflex-lexer">
      <param name="lexer.dir" value="${compiler.src}/${ext.pkg}/parse" />
      <param name="lexer.class" value="Lexer_c" />
      <param name="jflex.file" value="${ext}.flex" />
    </antcall>
  </target>

  <target name="jflex-lexer" depends="jflex-lexer-deps"
      unless="jflex.lexer.up-to-date">
    <java classname="JFlex.Main" fork="true" dir="${lexer.dir}"
        failonerror="true">
      <classpath refid="standard.classpath" />
      <arg value="${jflex.file}" />
    </java>
  </target>

  <target name="jflex-lexer-deps">
    <dependset>
      <srcfileset dir="${lexer.dir}" includes="${jflex.file}" />
      <targetfileset dir="${lexer.dir}" includes="${lexer.class}.java" />
    </dependset>
    <available property="jflex.lexer.up-to-date"
        file="${lexer.dir}/${lexer.class}.java" />
  </target>

  <target name="standard-ext-ppg-parser">
    <antcall target="ppg-parser">
      <param name="parser.dir" value="${compiler.src}/${ext.pkg}/parse" />
      <param name="ppg.file" value="${ext}.ppg" />
      <param name="cup.file" value="${ext}_ppg.cup" />
      <param name="parser.class" value="Grm" />
      <param name="symbol.class" value="sym" />
    </antcall>
  </target>

  <target name="ppg-parser" depends="ppg-parser-deps"
      unless="ppg.parser.up-to-date">
    <java classname="ppg.PPG" fork="true" dir="${parser.dir}"
        output="${parser.dir}/${cup.file}" failonerror="true">
      <classpath refid="standard.classpath" />
      <arg value="${ppg.file}" />
    </java>
    <antcall target="cup-parser" />
  </target>

  <target name="ppg-parser-deps">
    <dependset>
      <srcfileset dir="${parser.dir}" includes="${ppg.file}" />
      <targetfileset dir="${parser.dir}">
        <include name="${cup.file}" />
        <include name="${parser.class}.java" />
        <include name="${symbol.class}.java" />
      </targetfileset>
    </dependset>
    <condition property="ppg.parser.up-to-date">
      <and>
        <available file="${parser.dir}/${cup.file}" />
        <available file="${parser.dir}/${parser.class}.java" />
        <available file="${parser.dir}/${symbol.class}.java" />
      </and>
    </condition>
  </target>

  <target name="cup-parser" depends="cup-parser-using-jar"
    unless="cup.parser.up-to-date">
  </target>

  <target name="cup-parser-using-jar" depends="cup-parser-deps"
      unless="cup.parser.up-to-date">
    <java classname="java_cup.Main" fork="true" dir="${parser.dir}"
        failonerror="true">
      <classpath refid="standard.classpath" />
      <arg value="-parser"/>
      <arg value="${parser.class}"/>
      <arg value="-symbols"/>
      <arg value="${symbol.class}"/>
      <arg value="${cup.file}"/>
    </java>
  </target>

  <target name="cup-parser-deps">
    <dependset>
      <srcfileset dir="${parser.dir}" includes="${cup.file}" />
      <targetfileset dir="${parser.dir}">
        <include name="${parser.class}.java" />
        <include name="${symbol.class}.java" />
      </targetfileset>
    </dependset>
    <condition property="cup.parser.up-to-date">
      <and>
        <available file="${parser.dir}/${parser.class}.java" />
        <available file="${parser.dir}/${symbol.class}.java" />
      </and>
    </condition>
  </target>

  <target name="standard-ext-qq-dep" if="has-qq">
    <antcall target="standard-ext-qq" />
  </target>

  <target name="standard-ext-qq">
    <antcall target="jflex-lexer">
      <param name="lexer.dir" value="${compiler.src}/${ext.pkg}/qq" />
      <param name="lexer.class" value="Lexer_c" />
      <param name="jflex.file" value="qq.flex" />
    </antcall>
    <antcall target="ppg-parser">
      <param name="parser.dir" value="${compiler.src}/${ext.pkg}/qq" />
      <param name="ppg.file" value="qq.ppg" />
      <param name="cup.file" value="qq_ppg.cup" />
      <param name="parser.class" value="Grm" />
      <param name="symbol.class" value="sym" />
    </antcall>
  </target>

  <target name="compile-ext">
    <javac source="1.5" target="1.5" srcdir="${compiler.src}"
        destdir="${classes}" debug="on" includes="${ext.pkg}/**">
      <classpath refid="standard.classpath" />
    </javac>
  </target>

</project>

