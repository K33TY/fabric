public class SimpleMemoTest {

  private static Store s = Worker.getWorker().getStore("store");

  /**
   * Needed for making remote copies of SimpleMemoTests.
   */
  public SimpleMemoTest SimpleMemoTest$() {
    fabric$lang$Object$();
    return this;
  }

  public static class Msg {
    public final int id;
    public Msg SimpleMemoTest$Msg$() {
      fabric$lang$Object$();
      return this;
    }

    public Msg(int id) {
      this.id = id;
    }
  }

  public memoized Msg dumbestTestEver(Msg m) {
    try { Thread.sleep(2000); } catch (InterruptedException e) { }
    return m;
  }

  public memoized Msg foo(int n) {
    try { Thread.sleep(500); } catch (InterruptedException e) { }
    return new Msg@s(n).SimpleMemoTest$Msg$().SimpleMemoTest$Msg$();
  }

  public memoized Msg localFoo(int n) {
    try { Thread.sleep(500); } catch (InterruptedException e) { }
    return new Msg(n).SimpleMemoTest$Msg$().SimpleMemoTest$Msg$();
  }

  public memoized long fib(int n) {
    //System.out.println("Computing fib(" + n + ")");
    try { Thread.sleep(100); } catch (InterruptedException e) { }
    if (n == 0) return 0;
    if (n == 1) return 1;
    return fib(n - 1) + fib(n - 2);
  }

  public static void main(String[] args) {
    SimpleMemoTest testSimpleMemoTest = null;
    SimpleMemoTest localSimpleMemoTest = null;
    Msg m = null;
    atomic {
      testSimpleMemoTest = new SimpleMemoTest@s().SimpleMemoTest$().SimpleMemoTest$();
      localSimpleMemoTest = new SimpleMemoTest();
      m = new Msg@s(20).SimpleMemoTest$Msg$().SimpleMemoTest$Msg$();
      System.out.println(testSimpleMemoTest.dumbestTestEver(m));
      for (int i = 0; i < 10; i++) {
        System.out.println("testSimpleMemoTest.foo(" + i + "): " + testSimpleMemoTest.foo(i));
        // Tests reuse within the same transaction it was created
        System.out.println("testSimpleMemoTest.foo(" + i + "): " + testSimpleMemoTest.foo(i));
        System.out.println("localSimpleMemoTest.localFoo(" + i + "): " + localSimpleMemoTest.localFoo(i));
        // Tests reuse within the same transaction it was created
        System.out.println("localSimpleMemoTest.localFoo(" + i + "): " + localSimpleMemoTest.localFoo(i));
      }
      System.out.println("FIB(50): " + testSimpleMemoTest.fib(50));
      System.out.println("FIB(50): " + testSimpleMemoTest.fib(50));
    }
    atomic {
      System.out.println(testSimpleMemoTest.dumbestTestEver(m));
      for (int i = 0; i < 10; i++) {
        System.out.println("testSimpleMemoTest.foo(" + i + "): " + testSimpleMemoTest.foo(i));
        // Tests reuse within the same transaction it was created
        System.out.println("testSimpleMemoTest.foo(" + i + "): " + testSimpleMemoTest.foo(i));
        System.out.println("localSimpleMemoTest.localFoo(" + i + "): " + localSimpleMemoTest.localFoo(i));
        // Tests reuse within the same transaction it was created
        System.out.println("localSimpleMemoTest.localFoo(" + i + "): " + localSimpleMemoTest.localFoo(i));
      }
      System.out.println("FIB(50): " + testSimpleMemoTest.fib(50));
      System.out.println("FIB(50): " + testSimpleMemoTest.fib(50));
    }
  }
}

