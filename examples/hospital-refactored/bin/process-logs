#!/bin/bash

# Ugh, it's in bash.  Sue me.
VAR_DIR=$1

if [ -z "${VAR_DIR}" ]; then
	echo "Point me to the var directory with the logs!";
	exit 1;
fi

# Figure out which one is the alice log and which one is the carol log
ALICE_FILE=""
for file in `ls ${VAR_DIR}/log/` ; do
	head -n 1 ${VAR_DIR}/log/$file | grep -q "alicenode" && ALICE_FILE=${VAR_DIR}/log/$file && continue;
done

if [ -z "${ALICE_FILE}" ] ; then 
	echo "COULDN'T FIND ALICE!";
	exit 1;
fi

# Post process alice, we want to filter out those commits from when carol was running.
ALICE_THREAD="thread "$(head -n 1000 ${ALICE_FILE} | cut -d, -f3 | sed 's/^ *//' | sort | uniq -c | sort -n | tail -n 1 | sed 's/^ *//' | cut -d' ' -f3)

echo "HIV READER: (${ALICE_THREAD})"
grep -h "${ALICE_THREAD}" ${ALICE_FILE} | $(dirname $0)/numbers 
